trigger:
- master

jobs:

- job: Run_Ansible_and_Serverspec
  strategy:
    matrix:
      macMojave:
        imageName: 'macOS-10.14'
      macCatalina:
        imageName: 'macOS-10.15'
  pool:
    vmImage: $(imageName)
  steps:
  - task: UseRubyVersion@0
    inputs:
      versionSpec: '= 2.4'
  - task: GoTool@0
    inputs:
      version: '1.11.4'

  - task: NodeTool@0 
    inputs:
      versionSpec: '10.15.3'

  - script: |
      brew unlink python@3.8 # AzureのPythonを解除
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
      brew install ansible
    displayName: 'Install Ansible'
    
  - script: |
      rm -rf /usr/local/bin/node
    displayName: 'Uninstall default node'
    
    
  - script: |
      make setup TARGET=mac
    displayName: 'Run Ansible'
    
  - script: |
      make before-check TARGET=mac
    displayName: 'Before Run Serverspec'

  - script: |
      make check TARGET=mac
    displayName: 'Run Serverspec'
